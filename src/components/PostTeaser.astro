---
import { sanityClient } from 'sanity:client';
import imageUrlBuilder from '@sanity/image-url';
import type { SanityImageSource } from '@sanity/image-url';

const imageBuilder = imageUrlBuilder(sanityClient).format('webp');

export type Props = {
  imageSizes: string;
  lazy?: boolean;
  post: PostTeaser;
};

const { imageSizes, lazy = false, post } = Astro.props;

const sizes = [256, 360, 440, 529, 625, 729, 841, 961, 1024];

// @TODO: Refactor to use `astro-sanity-picture`.
function urlFor(source: SanityImageSource, size: number): string {
  return imageBuilder.image(source).width(size).height(size).url();
}
---

<article
  class="group relative aspect-square overflow-hidden rounded-xl bg-surface shadow-sm ring-1 ring-inset ring-current/5 transition-all duration-300 hover:shadow-lg hover:ring-current/10 dark:bg-surface-dark"
>
  <a
    href={`/post/${post.slug}`}
    class="block h-full w-full"
    aria-label={`View ${post.title}`}
  >
    {
      post?.mainImage && (
        <figure class="relative h-full w-full overflow-hidden bg-current/5">
          <img
            alt={post.mainImage?.alt || post.title}
            title={post.mainImage?.alt || post.title}
            class="h-full w-full object-cover transition-transform duration-500 group-hover:scale-105"
            srcset={sizes
              .map((size) => `${urlFor(post.mainImage, size)} ${size}w`)
              .join(', ')}
            sizes={imageSizes}
            src={urlFor(post.mainImage, 768)}
            width="1024"
            height="1024"
            loading={lazy ? 'lazy' : 'eager'}
          />
          <div
            class="absolute inset-0 bg-gradient-to-t from-black via-black/80 to-transparent"
            style="background: linear-gradient(to top, rgba(0, 0, 0, 1) 0%, rgba(0, 0, 0, 0.8) 50%, transparent 100%);"
          />
        </figure>
      )
    }
    <div class="absolute inset-0 flex items-end p-3 lg:p-5">
      <h3 class="type-h5 text-white drop-shadow-lg">
        <span class="line-clamp-2">{post.title}</span>
      </h3>
    </div>
  </a>
</article>
