---
import { Heading, Text, Wordmark } from '~/components';
import BaseLayout from './BaseLayout.astro';

type meta = {
  title?: string;
  description?: string;
  image?: string;
};

export type Props = {
  meta?: meta;
};

const { meta } = Astro.props;
---

<BaseLayout meta={meta}>
  <header
    class="sticky top-0 w-full mb-8 z-50 py-4 bg-white/70 dark:bg-black/70 backdrop-blur-lg transition-all duration-300"
    transition:name="site-header"
    transition:persist
  >
    <div class="container flex items-center justify-center md:justify-start">
      <a class="block w-full md:w-auto text-lg lg:text-2xl" href="/">
        <Wordmark />
      </a>

      <div class="relative ml-auto w-64 md:w-96 lg:w-128 max-w-full">
        <div id="autocomplete"></div>
        <!-- <div id="searchbox"></div>
        <div id="hits"></div> -->
      </div>

      <!-- <div class="relative ml-auto">
        <form class="relative w-64 md:w-96 lg:w-128 overflow-hidden">
          <input
            type="search"
            dir="ltr"
            spellcheck="false"
            autocorrect="off"
            autocomplete="off"
            autocapitalize="off"
            maxlength="2048"
            tabindex="1"
            class="w-full px-4 py-2 border-2 border-gray-500/50 bg-gray-100/10 text-sm focus:outline-none transition-color duration-300 rounded-full focus:border-current transition-color"
            type="search"
            placeholder="Type to search..."
          />
          <kbd
            class="absolute top-1/2 right-3 inline-block flex-grow-0 text-gray-500 border border-current rounded-md py-1 px-2 leading-none pointer-events-none -translate-y-1/2"
            >/</kbd
          >
        </form>
      </div> -->
    </div>
  </header>

  <main class="flex-1 w-full" transition:animate="fade">
    <slot />
  </main>

  <footer class="mt-8 md:mt-12 lg:mt-16 mb-16 md:mb-24 lg:mb-32 w-full">
    <div class="container">
      <div
        class="grid gap-y-8 gap-x-16 md:grid-cols-2 xl:grid-cols-4 text-center md:text-start"
      >
        <div class="md:col-span-2 xl:col-span-1">
          <a class="block w-full md:w-auto text-lg" href="/">
            <Wordmark />
          </a>
        </div>

        <div class="space-y-4 xl:col-span-2">
          <Heading
            as="p"
            size="h5"
            class:list="leading-none border-t-2 border-current pt-8 lg:mt-4"
          >
            About
          </Heading>
          <Text size="sm">
            Manhole is a collection of images of manhole covers from around the
            world.
          </Text>
          <Text size="sm">
            Manhole is an open source project by <a
              href="https://callum.co.uk"
              target="_blank"
              class="link">Callum Bonnyman</a
            >.
          </Text>
        </div>

        <div class="space-y-4">
          <Heading
            as="p"
            size="h5"
            class:list="leading-none border-t-2 border-current pt-8 lg:mt-4"
          >
            Like this website?
          </Heading>
          <Text size="sm">
            Check out and star the project on
            <a
              href="https://github.com/wrux/manhole"
              rel="nofollow"
              class="link"
              target="_blank">Github</a
            >.
          </Text>
        </div>
      </div>
    </div>
  </footer>
</BaseLayout>

<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/instantsearch.css@8.1.0/themes/reset-min.css"
  integrity="sha256-2AeJLzExpZvqLUxMfcs+4DWcMwNfpnjUeAAvEtPr0wU="
  crossorigin="anonymous"
/>

<script>
  import algoliasearch from 'algoliasearch/lite';
  import { autocomplete, getAlgoliaResults } from '@algolia/autocomplete-js';
  import '@algolia/autocomplete-theme-classic';

  // import { algoliaAdminClient, algoliaSearchClient } from '~/algolia/config';

  const searchClient = algoliasearch(
    'X4W8BJTPMP',
    '46015b7fec639392393b8c8dba585028'
  );

  function getDocumentUrl(document: any) {
    if (document._type === 'post') return `/post/${document.path}`;
    // if (document.type === 'location' && document.locationType === 'country')
    //   return `/country/${document.path}`;
    return '/';
  }

  autocomplete({
    container: '#autocomplete',
    placeholder: 'Search posts',
    // navigator: {
    //   navigate(test) {
    //     console.log('NAV', test);
    //   },
    // },
    getSources({ query }) {
      return [
        {
          sourceId: 'posts',
          getItemUrl: ({ item }) => getDocumentUrl(item),
          getItems() {
            return getAlgoliaResults({
              searchClient,
              queries: [
                {
                  indexName: 'prod_manhole',
                  query,
                  params: {
                    hitsPerPage: 5,
                  },
                },
              ],
            });
          },

          templates: {
            item({ item, components, html }) {
              return html`<a
                href="${getDocumentUrl(item)}"
                class="aa-ItemWrapper"
              >
                <div class="aa-ItemContent">
                  <div class="aa-ItemContentBody">
                    <div class="aa-ItemContentTitle">
                      ${components.Highlight({
                        hit: item,
                        attribute: 'title',
                      })}
                    </div>
                    <div class="aa-ItemContentDescription">
                      ${components.Snippet({
                        hit: item,
                        attribute: 'summary',
                      })}
                    </div>
                  </div>
                  <div class="aa-ItemActions">
                    <button
                      class="aa-ItemActionButton aa-DesktopOnly aa-ActiveOnly"
                      type="button"
                      title="View ${item.title}"
                    >
                      <svg
                        viewBox="0 0 24 24"
                        width="20"
                        height="20"
                        fill="currentColor"
                      >
                        <path
                          d="M18.984 6.984h2.016v6h-15.188l3.609 3.609-1.406 1.406-6-6 6-6 1.406 1.406-3.609 3.609h13.172v-4.031z"
                        />
                      </svg>
                    </button>
                  </div>
                </div>
              </a>`;
            },
          },
        },
      ];
    },
  });
</script>
