---
import imageUrlBuilder from '@sanity/image-url';
import type { SanityImageSource } from '@sanity/image-url';
import { getPosts } from '~/sanity/queries';
import { sanityClient } from 'sanity:client';
import {
  CountryShape,
  Credits,
  PortableText,
  PostTeaser,
} from '~/components';
import PageLayout from '~/layouts/PageLayout.astro';

const imageBuilder = imageUrlBuilder(sanityClient).format('webp');

const sizes = [256, 360, 440, 529, 625, 729, 841, 961, 1024];

// @TODO: Refactor to use `astro-sanity-picture`.
function urlFor(source: SanityImageSource, size: number): string {
  return imageBuilder.image(source).width(size).height(size).url();
}

export async function getStaticPaths() {
  const posts = await getPosts();
  return posts.map((posts) => ({
    params: { slug: posts.slug },
    props: posts,
  }));
}

const post = Astro.props as Post;

const author = post?.credits?.find((credit) => credit.type === 'author');
const schema = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  mainEntityOfPage: `https://manhole.design/posts/${post.slug}`,
  headline: post.title,
  name: post.title,
  description: post.summaryHTML,
  datePublished: post._createdAt.substring(0, 10),
  ...(post._updatedAt &&
    post._createdAt !== post._createdAt && {
      dateModified: post._updatedAt.substring(0, 10),
    }),
  ...(author && {
    author: {
      '@type': 'Person',
      name: author?.person?.fullName,
      url: author?.person?.website,
    },
  }),
  ...(post.mainImage && {
    image: {
      '@type': 'ImageObject',
      '@id': urlFor(post.mainImage, 1000),
      url: urlFor(post.mainImage, 1000),
      height: '1000',
      width: '1000',
    },
  }),
  url: `https://manhole.design/posts/${post.slug}`,
  isPartOf: {
    '@type': 'Blog',
    '@id': 'https://manhole.gallery/',
    name: 'Manhole · Gallery',
    publisher: {
      '@type': 'Organization',
      '@id': 'https://manhole.gallery/',
      name: 'Manhole · Gallery',
    },
  },
};

const country = post?.locations?.find(
  (location) => location.type === 'country',
) as Country;
---

<PageLayout
  meta={{
    title: `${post.title} | Manhole Gallery`,
    description: post?.metaDescription,
    image:
      post.mainImage &&
      imageBuilder.image(post.mainImage).width(1600).height(900).url(),
  }}
>
  <article class="container mb-20 lg:mb-24">
    <div class="mx-auto max-w-6xl">
      <div class="mb-12 grid gap-12 lg:grid-cols-2 lg:items-start">
        <div class="order-2 lg:order-1">
          {
            post?.mainImage && (
              <figure class="relative overflow-hidden rounded-2xl bg-surface shadow-xl dark:bg-surface-dark">
                <img
                  alt={post.mainImage?.alt || post.title}
                  title={post.mainImage?.alt || post.title}
                  class="aspect-square w-full object-cover"
                  srcset={sizes
                    .map((size) => `${urlFor(post.mainImage, size)} ${size}w`)
                    .join(', ')}
                  sizes="(max-width: 1023px) 100vw, 50vw"
                  src={urlFor(post.mainImage, 1024)}
                  width="1024"
                  height="1024"
                />
                <div class="absolute inset-0 rounded-2xl ring-1 ring-inset ring-current/5"></div>
              </figure>
            )
          }
        </div>

        <div class="order-1 space-y-8 lg:order-2 lg:sticky lg:top-24">
          {
            post?.locations?.length > 0 && (
              <div class="flex flex-wrap items-center gap-3">
                {country && country?.countryCode && (
                  <CountryShape
                    countryCode={country.countryCode}
                    size="xs"
                    transition:name={`country_${country._id}`}
                  />
                )}

                {post?.locations && (
                  <div
                    class="flex flex-wrap items-center gap-2"
                    transition:name={`post_${post._id}_locations`}
                  >
                    <span class="sr-only">Locations:</span>
                    {post.locations.map((location) =>
                      location.type === 'country' ? (
                        <a
                          href={`/country/${location.slug}`}
                          class="type-sm rounded-full border border-current/20 px-3 py-1 transition-all hover:border-secondary hover:bg-secondary/10"
                        >
                          {location.name}
                        </a>
                      ) : (
                        <span class="type-sm text-current/70">{location.name}</span>
                      ),
                    )}
                  </div>
                )}
              </div>
            )
          }

          <h1 class="type-h1 mb-6" transition:name={`post_${post._id}_title`}>
            {post.title}
          </h1>

          {
            (post?.body || post?.summary) && (
              <div
                class="prose prose-lg max-w-none text-current/80 prose-headings:font-bold prose-headings:text-current prose-a:link-reverse prose-strong:text-current"
                transition:name={`post_${post._id}_description`}
              >
                <PortableText value={post.body || post.summary} components={{}} />
              </div>
            )
          }

          {
            post?.credits && post.credits.length > 0 && (
              <Credits
                credits={post.credits}
                transition:name={`post_${post._id}_credits`}
              />
            )
          }
        </div>
      </div>
    </div>
  </article>

  {
    post?.morePosts && post?.morePosts?.length > 0 && (
      <section class="mb-20 lg:mb-24">
        <div class="container mb-12 text-center">
          <h2 class="type-h2 mb-4">More from the Gallery</h2>
          <p class="type-md text-current/70">Discover more manhole cover designs</p>
        </div>
        <div class="gallery-grid w-full px-4 sm:px-6 lg:px-8 xl:px-12">
          {post.morePosts.map((post) => (
            <PostTeaser
              imageSizes="(max-width: 474px) 100vw, (max-width: 1023px) 50vw, 20.625rem"
              lazy
              post={post}
            />
          ))}
        </div>
      </section>
    )
  }

  <script type="application/ld+json" set:html={JSON.stringify(schema)} />
</PageLayout>
